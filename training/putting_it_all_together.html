
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Putting it all together &#8212; Open-Source Tools &amp; Data for Music Source Separation</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/myfile.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Applications" href="../conclusions/applications.html" />
    <link rel="prev" title="Code for Building Blocks" href="building_blocks.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">Open-Source Tools & Data for Music Source Separation</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../landing.html">
   Welcome!
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/tutorial_structure.html">
   Tutorial Structure and Setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/src_sep_101.html">
   What is Source Separation?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/open_src_projects.html">
   Map of Open-Source Source Separation Projects
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Basics of Source Separation
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../basics/representations.html">
   Representing Audio
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../basics/tf_and_masking.html">
   TF Representations and Masking
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../basics/phase.html">
   Phase
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../basics/evaluation.html">
   Evaluation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  First Steps
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../first_steps/nussl_intro.html">
   Introduction to nussl
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../first_steps/repetition.html">
   Putting it All Together: Repetition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../first_steps/byo_hpss.html">
   Build Your Own HPSS
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Deep Learning Approaches
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../approaches/deep/introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../approaches/deep/building_blocks.html">
   Building Blocks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../approaches/deep/architectures.html">
   Architectures
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Data
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../data/introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/datasets.html">
   Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/musdb18.html">
   The MUSDB18 dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/scaper.html">
   Generating mixtures with Scaper
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Training
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Training deep nets for dummies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="gradient_descent.html">
   Gradient descent
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="building_blocks.html">
   Code for Building Blocks
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Putting it all together
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Conclusions
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../conclusions/applications.html">
   Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../conclusions/concluding_remarks.html">
   Concluding Remarks
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../zzz_refs.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../appendix/resources.html">
   Additional Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../appendix/acknowledgements.html">
   Acknowledgements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../appendix/authors.html">
   About the Authors
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/training/putting_it_all_together.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/source-separation/tutorial"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/source-separation/tutorial/issues/new?title=Issue%20on%20page%20%2Ftraining/putting_it_all_together.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/source-separation/tutorial/master?urlpath=tree/book/training/putting_it_all_together.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/source-separation/tutorial/blob/master/book/training/putting_it_all_together.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#getting-the-data">
   Getting the data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-transforms">
     Data transforms
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#building-the-model">
   Building the model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training">
   Training
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deployment">
   Deployment
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="putting-it-all-together">
<h1>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h1>
<p>The goal of this chapter is to provide a fully annotated and functional
script for training a vocals separation model using <code class="docutils literal notranslate"><span class="pre">nussl</span></code> and <code class="docutils literal notranslate"><span class="pre">Scaper</span></code>,
putting together everything that we’ve seen in this tutorial thus far. So that
this part runs in reasonable time, we’ll set up our model training code so that
it overfits to a small amount of data, and then show the output of the model
on that data. We’ll also give instructions on how to scale your experiment code up
so that it’s a full MUSDB separation experiment.</p>
<p>We’ll have to introduce a few concepts in <code class="docutils literal notranslate"><span class="pre">nussl</span></code> that hasn’t been covered yet that
will make our lives easier. Alright, let’s get started!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
!pip install git+https://github.com/source-separation/tutorial
</pre></div>
</div>
</div>
</div>
<div class="section" id="getting-the-data">
<h2>Getting the data<a class="headerlink" href="#getting-the-data" title="Permalink to this headline">¶</a></h2>
<p>The first concept we’ll want to be familiar with is that of data transforms. <code class="docutils literal notranslate"><span class="pre">nussl</span></code> provides
a transforms API for audio, much like the one found in <code class="docutils literal notranslate"><span class="pre">torchvision</span></code> does for image data.
Remember all that data code we built up in the previous section? Let’s get it back, this
time by just importing it from the <code class="docutils literal notranslate"><span class="pre">common</span></code> module that comes with this tutorial:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">viz</span>
<span class="kn">import</span> <span class="nn">nussl</span>
<span class="c1"># Prepare MUSDB</span>
<span class="n">data</span><span class="o">.</span><span class="n">prepare_musdb</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The next bit of code initializes a Scaper object with all the bells and whistles
that were introduced in the last section, then wraps it in a nussl OnTheFly
dataset. First, we should set our STFTParams to what we’ll be using throughout
this notebook:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stft_params</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">STFTParams</span><span class="p">(</span><span class="n">window_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">window_type</span><span class="o">=</span><span class="s1">&#39;sqrt_hann&#39;</span><span class="p">)</span>
<span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/train&quot;</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ScaperError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">87</span><span class="n">fd1ff92a83</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">stft_params</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">STFTParams</span><span class="p">(</span><span class="n">window_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">window_type</span><span class="o">=</span><span class="s1">&#39;sqrt_hann&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/train&quot;</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/argbind.py</span> in <span class="ni">cmd_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">parse_dict_to_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span> 
<span class="ne">--&gt; </span><span class="mi">192</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>         <span class="k">return</span> <span class="n">cmd_func</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> 

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">mixer</span><span class="nt">(stft_params, transform, num_mixtures, fg_path, duration, sample_rate, ref_db, n_channels, master_label, source_file, snr, target_instrument, target_snr_boost, pitch_shift, time_stretch, coherent_prob, augment_prob, quick_pitch_time_prob, overfit, overfit_seed)</span>
<span class="g g-Whitespace">    </span><span class="mi">286</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">OnTheFly</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>         <span class="n">mix_closure</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="p">,</span> <span class="n">stft_params</span><span class="o">=</span><span class="n">stft_params</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">288</span>         <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="k">return</span> <span class="n">dataset</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">__init__</span><span class="nt">(self, mix_closure, num_mixtures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span>         <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span> <span class="o">=</span> <span class="n">mix_closure</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span> 
<span class="ne">--&gt; </span><span class="mi">404</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span>         <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;num_mixtures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_mixtures</span>
<span class="g g-Whitespace">    </span><span class="mi">406</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/base_dataset.py</span> in <span class="ni">__init__</span><span class="nt">(self, folder, transform, sample_rate, stft_params, num_channels, strict_sample_rate, cache_populated)</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span>         <span class="c1"># signals if necessary, if there are any items</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">96</span>             <span class="bp">self</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span> 
<span class="g g-Whitespace">     </span><span class="mi">98</span>     <span class="k">def</span> <span class="nf">filter_items_by_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">process_item</span><span class="nt">(self, item)</span>
<span class="g g-Whitespace">    </span><span class="mi">409</span> 
<span class="g g-Whitespace">    </span><span class="mi">410</span>     <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">411</span>         <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">412</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>             <span class="k">raise</span> <span class="n">DataSetException</span><span class="p">(</span><span class="s2">&quot;output of mix_closure must be a dict!&quot;</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">__call__</span><span class="nt">(self, dataset, i)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>         <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span>             <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">415</span>             <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_scaper_object</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>             <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent_prob</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>                 <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">_create_scaper_object</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span>         <span class="n">sc</span> <span class="o">=</span> <span class="n">scaper</span><span class="o">.</span><span class="n">Scaper</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>             <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">354</span>             <span class="n">random_state</span><span class="o">=</span><span class="n">state</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>         <span class="n">sc</span><span class="o">.</span><span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/core.py</span> in <span class="ni">__init__</span><span class="nt">(self, duration, fg_path, bg_path, protected_labels, random_state)</span>
<span class="g g-Whitespace">   </span><span class="mi">1026</span>         <span class="n">expanded_fg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span>         <span class="n">expanded_bg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">bg_path</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1028</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_bg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span>         <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span> <span class="o">=</span> <span class="n">expanded_fg_path</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/util.py</span> in <span class="ni">_validate_folder_path</span><span class="nt">(folder_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>         <span class="k">raise</span> <span class="n">ScaperError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>             <span class="s1">&#39;Folder path &quot;</span><span class="si">{:s}</span><span class="s1">&quot; does not point to a valid folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">116</span>                 <span class="nb">str</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span> 
<span class="g g-Whitespace">    </span><span class="mi">118</span> 

<span class="ne">ScaperError</span>: Folder path &quot;/home/runner/.nussl/tutorial/train&quot; does not point to a valid folder
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at a single item from the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">viz</span><span class="o">.</span><span class="n">show_sources</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">62</span><span class="n">db4414b75b</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">viz</span><span class="o">.</span><span class="n">show_sources</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;train_data&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Recall that the mixture above is generated above using Scaper and may be coherent or incoherent!
The ratio is controlled by <code class="docutils literal notranslate"><span class="pre">data.mixer(...,</span> <span class="pre">coherent_prob=0.5)</span></code>. Go ahead and use the cell below
to listen to a few more examples, as well as play around with the various arguments to <code class="docutils literal notranslate"><span class="pre">data.mixer</span></code>.</p>
<p>Now that we’ve got some training data, we’ll also need to make validation and test datasets:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/valid&quot;</span>
<span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/test&quot;</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ScaperError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">067</span><span class="n">b3b38be57</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/valid&quot;</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/test&quot;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/argbind.py</span> in <span class="ni">cmd_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">parse_dict_to_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span> 
<span class="ne">--&gt; </span><span class="mi">192</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>         <span class="k">return</span> <span class="n">cmd_func</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> 

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">mixer</span><span class="nt">(stft_params, transform, num_mixtures, fg_path, duration, sample_rate, ref_db, n_channels, master_label, source_file, snr, target_instrument, target_snr_boost, pitch_shift, time_stretch, coherent_prob, augment_prob, quick_pitch_time_prob, overfit, overfit_seed)</span>
<span class="g g-Whitespace">    </span><span class="mi">286</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">OnTheFly</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>         <span class="n">mix_closure</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="p">,</span> <span class="n">stft_params</span><span class="o">=</span><span class="n">stft_params</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">288</span>         <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="k">return</span> <span class="n">dataset</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">__init__</span><span class="nt">(self, mix_closure, num_mixtures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span>         <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span> <span class="o">=</span> <span class="n">mix_closure</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span> 
<span class="ne">--&gt; </span><span class="mi">404</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span>         <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;num_mixtures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_mixtures</span>
<span class="g g-Whitespace">    </span><span class="mi">406</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/base_dataset.py</span> in <span class="ni">__init__</span><span class="nt">(self, folder, transform, sample_rate, stft_params, num_channels, strict_sample_rate, cache_populated)</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span>         <span class="c1"># signals if necessary, if there are any items</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">96</span>             <span class="bp">self</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span> 
<span class="g g-Whitespace">     </span><span class="mi">98</span>     <span class="k">def</span> <span class="nf">filter_items_by_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">process_item</span><span class="nt">(self, item)</span>
<span class="g g-Whitespace">    </span><span class="mi">409</span> 
<span class="g g-Whitespace">    </span><span class="mi">410</span>     <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">411</span>         <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">412</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>             <span class="k">raise</span> <span class="n">DataSetException</span><span class="p">(</span><span class="s2">&quot;output of mix_closure must be a dict!&quot;</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">__call__</span><span class="nt">(self, dataset, i)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>         <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span>             <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">415</span>             <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_scaper_object</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>             <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent_prob</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>                 <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">_create_scaper_object</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span>         <span class="n">sc</span> <span class="o">=</span> <span class="n">scaper</span><span class="o">.</span><span class="n">Scaper</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>             <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">354</span>             <span class="n">random_state</span><span class="o">=</span><span class="n">state</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>         <span class="n">sc</span><span class="o">.</span><span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/core.py</span> in <span class="ni">__init__</span><span class="nt">(self, duration, fg_path, bg_path, protected_labels, random_state)</span>
<span class="g g-Whitespace">   </span><span class="mi">1026</span>         <span class="n">expanded_fg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span>         <span class="n">expanded_bg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">bg_path</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1028</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_bg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span>         <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span> <span class="o">=</span> <span class="n">expanded_fg_path</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/util.py</span> in <span class="ni">_validate_folder_path</span><span class="nt">(folder_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>         <span class="k">raise</span> <span class="n">ScaperError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>             <span class="s1">&#39;Folder path &quot;</span><span class="si">{:s}</span><span class="s1">&quot; does not point to a valid folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">116</span>                 <span class="nb">str</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span> 
<span class="g g-Whitespace">    </span><span class="mi">118</span> 

<span class="ne">ScaperError</span>: Folder path &quot;/home/runner/.nussl/tutorial/valid&quot; does not point to a valid folder
</pre></div>
</div>
</div>
</div>
<p>Now that we’ve got all of our data, how do we actually feed it into our model? Each
item from this dataset is structured as a dictionary with the following keys:An</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mix</span></code>: An AudioSignal object with the mixture of all the sources</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sources</span></code>: A dictionary where keys are source labels, and values are corresponding
AudioSignal objects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metadata</span></code>: Metadata for the item - contains the corresponding JAMS file for the
generated mixture.</p></li>
</ul>
<p>For now, we are mostly concerned with the first two parts. Now, these are AudioSignal
object, so how do we get it into <code class="docutils literal notranslate"><span class="pre">nussl</span></code>? We’ll use <em>transforms</em>!</p>
<div class="section" id="data-transforms">
<h3>Data transforms<a class="headerlink" href="#data-transforms" title="Permalink to this headline">¶</a></h3>
<p>If you’ve looked at deep learning code for various vision tasks, you might have come
across that looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">])</span>
</pre></div>
</div>
<p>Each transform does something to an input image. <code class="docutils literal notranslate"><span class="pre">Compose</span></code> puts the transforms
together so they happen one after the other. In <code class="docutils literal notranslate"><span class="pre">nussl</span></code>, we’ve built up a very
similar API that takes in dictionaries of AudioSignal objects like above
that are produced by nussl datasets, and applies different transformations
to them. Specifically, we’ll use these transforms from <code class="docutils literal notranslate"><span class="pre">nussl</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SumSources</span></code>: combines the selected sources into a single source. We’ll use it to
combine drums, bass, and other sources into a single accompaniment source, which will
be helpful when evaluating our model’s performance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MagnitudeSpectrumApproximation</span></code>: computes the spectrograms of the targets and
the spectrogram of the mixture. The first is used for our loss and the second is used
as input to the model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IndexSources</span></code>: for the output of the model, we only care about the estimate of the vocals,
so we’ll use this transform to discard the other target spectrograms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ToSeparationModel</span></code>: converts all of the values in the dictionary to Tensors so they can
be fed to our model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Compose</span></code>: we’ll use this transform to combine all of the above so they happen sequentially.</p></li>
</ul>
<p>Let’s look at each of these transforms and what they do to our data dictionary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nussl.datasets</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">nussl_tfm</span>

<span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sum_sources</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">SumSources</span><span class="p">([[</span><span class="s1">&#39;bass&#39;</span><span class="p">,</span> <span class="s1">&#39;drums&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]])</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">sum_sources</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="n">viz</span><span class="o">.</span><span class="n">show_sources</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mi">57636</span><span class="n">a1d48eb</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">nussl.datasets</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">nussl_tfm</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">sum_sources</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">SumSources</span><span class="p">([[</span><span class="s1">&#39;bass&#39;</span><span class="p">,</span> <span class="s1">&#39;drums&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">item</span> <span class="o">=</span> <span class="n">sum_sources</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;train_data&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>There are now only two sources: vocals, and bass+drums+other (accompaniment). Next, let’s extract input and
targets for training:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">msa</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">MagnitudeSpectrumApproximation</span><span class="p">()</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">msa</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="n">a081b7616d7f</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">msa</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">MagnitudeSpectrumApproximation</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">item</span> <span class="o">=</span> <span class="n">msa</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We see that three new keys were added:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mix_magnitude</span></code>: The magnitude spectrogram of the mixture, as a numpy array.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source_magnitudes</span></code>: The magnitude spectrogram of each source, as a numpy array.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ideal_binary_mask</span></code>: The ideal binary mask for each source.</p></li>
</ul>
<p>Let’s take a look at their shapes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mix_magnitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;ideal_binary_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">3</span><span class="n">d7e91e2e947</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mix_magnitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;ideal_binary_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The dimensions of each are:</p>
<ul class="simple">
<li><p>Number of frequency bins in STFT</p></li>
<li><p>Number of time steps in STFT</p></li>
<li><p>Number of audio channels</p></li>
<li><p>Number of sources - only for <code class="docutils literal notranslate"><span class="pre">source_magnitudes</span></code> and <code class="docutils literal notranslate"><span class="pre">ideal_binary_mask</span></code></p></li>
</ul>
<p>The input to our model will be the data in <code class="docutils literal notranslate"><span class="pre">item['mix_magnitude']</span></code> and the targets will
from <code class="docutils literal notranslate"><span class="pre">item['source_magnitudes']</span></code>. We’ll not use <code class="docutils literal notranslate"><span class="pre">ideal_binary_mask</span></code> in this tutorial.</p>
<p>The next thing we need to do is extract only the <code class="docutils literal notranslate"><span class="pre">source_magnitudes</span></code> for the <code class="docutils literal notranslate"><span class="pre">vocals</span></code>
source, as that is the target of our network. To figure out which index the <code class="docutils literal notranslate"><span class="pre">vocals</span></code> are
at, know that the order of <code class="docutils literal notranslate"><span class="pre">source_magnitudes</span></code> is always in alphabetical order according
to source label. So, since our source labels were <code class="docutils literal notranslate"><span class="pre">bass+drums+other</span></code> and <code class="docutils literal notranslate"><span class="pre">vocals</span></code>, the
<code class="docutils literal notranslate"><span class="pre">vocals</span></code> source is the second source:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Magnitude spectrogram of vocals source&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time frame&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="n">f23897f025b0</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Magnitude spectrogram of vocals source&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time frame&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency bin&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We can do this inside a <code class="docutils literal notranslate"><span class="pre">transform</span></code> using <code class="docutils literal notranslate"><span class="pre">IndexSources</span></code>, which takes two
arguments:</p>
<ul class="simple">
<li><p>Which key to use for indexing</p></li>
<li><p>Which index (or indices) to extract</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index_sources</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">IndexSources</span><span class="p">(</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">index_sources</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mf">9e93</span><span class="n">fca68f88</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">index_sources</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">IndexSources</span><span class="p">(</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">item</span> <span class="o">=</span> <span class="n">index_sources</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the shapes again, and also plot it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Magnitude spectrogram of vocals source&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time frame&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency bin&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mix_magnitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;ideal_binary_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">767505</span><span class="n">bb7fdc</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Magnitude spectrogram of vocals source&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time frame&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency bin&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">item['source_magnitudes']</span></code> has only one source now, the vocals source. By changing
which index, we can change the sort of model we are training from a vocals model to an
accompaniment model, or to a drums model, etc. if we don’t use <code class="docutils literal notranslate"><span class="pre">SumSources</span></code>. Note that the
<code class="docutils literal notranslate"><span class="pre">ideal_binary_mask</span></code> shape is unaffected, as we didn’t tell <code class="docutils literal notranslate"><span class="pre">IndexSources</span></code> to operate on that
key.</p>
<p>Next, we’ve got to prep our data dictionary so that it can be fed to our model. To do this, we need
them to be PyTorch tensors. We also need to exclude anything that is incompatible with PyTorch
(such as the AudioSignal objects), and we’ll need to make sure the time axis is on the first
non-batch dimension. To do this, we’ll use the <code class="docutils literal notranslate"><span class="pre">ToSeparationModel</span></code> transform:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">to_separation_model</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">ToSeparationModel</span><span class="p">()</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">to_separation_model</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="n">a0f5256f6f3e</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">to_separation_model</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">ToSeparationModel</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">item</span> <span class="o">=</span> <span class="n">to_separation_model</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Let’s look at what’s in the dictionary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">13</span><span class="o">-</span><span class="n">b38d2730b062</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>So the <code class="docutils literal notranslate"><span class="pre">mix</span></code> and <code class="docutils literal notranslate"><span class="pre">sources</span></code> keys were discarded because they contained AudioSignal objects that can’t be fed to
a PyTorch model. The remaining keys look like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">14</span><span class="o">-</span><span class="mi">0</span><span class="n">a4eb90b199a</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>They’re all tensors, and the time-axis is correclty placed in the first dimension, which is
what <code class="docutils literal notranslate"><span class="pre">nussl</span></code>’s implementation of the different neural building blocks expects.</p>
<p>Finally, let’s put all of these together into a single transform:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfm</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">SumSources</span><span class="p">([[</span><span class="s1">&#39;bass&#39;</span><span class="p">,</span> <span class="s1">&#39;drums&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]]),</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">MagnitudeSpectrumApproximation</span><span class="p">(),</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">IndexSources</span><span class="p">(</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">ToSeparationModel</span><span class="p">(),</span>
<span class="p">])</span>

<span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before transforms&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">After transforms&quot;</span><span class="p">)</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">tfm</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">15</span><span class="o">-</span><span class="n">c54c7e6a16d9</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> 
<span class="ne">----&gt; </span><span class="mi">8</span> <span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before transforms&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>

<span class="ne">NameError</span>: name &#39;train_data&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We can initialize our mixer with these transforms so they always happen when we draw an
item from the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/train&quot;</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Item from train data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

<span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/valid&quot;</span>
<span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">test_tfm</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">SumSources</span><span class="p">([[</span><span class="s1">&#39;bass&#39;</span><span class="p">,</span> <span class="s1">&#39;drums&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]]),</span>
<span class="p">])</span>

<span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/test&quot;</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_tfm</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ScaperError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">22411</span><span class="n">ed8ae8c</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fg_path</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/train&quot;</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> <span class="n">fg_path</span><span class="o">=</span><span class="n">fg_path</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Item from train data&quot;</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/argbind.py</span> in <span class="ni">cmd_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">parse_dict_to_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span> 
<span class="ne">--&gt; </span><span class="mi">192</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>         <span class="k">return</span> <span class="n">cmd_func</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> 

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">mixer</span><span class="nt">(stft_params, transform, num_mixtures, fg_path, duration, sample_rate, ref_db, n_channels, master_label, source_file, snr, target_instrument, target_snr_boost, pitch_shift, time_stretch, coherent_prob, augment_prob, quick_pitch_time_prob, overfit, overfit_seed)</span>
<span class="g g-Whitespace">    </span><span class="mi">286</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">OnTheFly</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>         <span class="n">mix_closure</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="p">,</span> <span class="n">stft_params</span><span class="o">=</span><span class="n">stft_params</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">288</span>         <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="k">return</span> <span class="n">dataset</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">__init__</span><span class="nt">(self, mix_closure, num_mixtures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span>         <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span> <span class="o">=</span> <span class="n">mix_closure</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span> 
<span class="ne">--&gt; </span><span class="mi">404</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span>         <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;num_mixtures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_mixtures</span>
<span class="g g-Whitespace">    </span><span class="mi">406</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/base_dataset.py</span> in <span class="ni">__init__</span><span class="nt">(self, folder, transform, sample_rate, stft_params, num_channels, strict_sample_rate, cache_populated)</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span>         <span class="c1"># signals if necessary, if there are any items</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">96</span>             <span class="bp">self</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span> 
<span class="g g-Whitespace">     </span><span class="mi">98</span>     <span class="k">def</span> <span class="nf">filter_items_by_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">process_item</span><span class="nt">(self, item)</span>
<span class="g g-Whitespace">    </span><span class="mi">409</span> 
<span class="g g-Whitespace">    </span><span class="mi">410</span>     <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">411</span>         <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">412</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>             <span class="k">raise</span> <span class="n">DataSetException</span><span class="p">(</span><span class="s2">&quot;output of mix_closure must be a dict!&quot;</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">__call__</span><span class="nt">(self, dataset, i)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>         <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span>             <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">415</span>             <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_scaper_object</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>             <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent_prob</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>                 <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">_create_scaper_object</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span>         <span class="n">sc</span> <span class="o">=</span> <span class="n">scaper</span><span class="o">.</span><span class="n">Scaper</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>             <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">354</span>             <span class="n">random_state</span><span class="o">=</span><span class="n">state</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>         <span class="n">sc</span><span class="o">.</span><span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/core.py</span> in <span class="ni">__init__</span><span class="nt">(self, duration, fg_path, bg_path, protected_labels, random_state)</span>
<span class="g g-Whitespace">   </span><span class="mi">1026</span>         <span class="n">expanded_fg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span>         <span class="n">expanded_bg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">bg_path</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1028</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_bg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span>         <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span> <span class="o">=</span> <span class="n">expanded_fg_path</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/util.py</span> in <span class="ni">_validate_folder_path</span><span class="nt">(folder_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>         <span class="k">raise</span> <span class="n">ScaperError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>             <span class="s1">&#39;Folder path &quot;</span><span class="si">{:s}</span><span class="s1">&quot; does not point to a valid folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">116</span>                 <span class="nb">str</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span> 
<span class="g g-Whitespace">    </span><span class="mi">118</span> 

<span class="ne">ScaperError</span>: Folder path &quot;/home/runner/.nussl/tutorial/train&quot; does not point to a valid folder
</pre></div>
</div>
</div>
</div>
<p>Note that when used inside a dataset, there is one additional item which is the
index of the dataset item. This is for <code class="docutils literal notranslate"><span class="pre">nussl.datasets.transforms.Cache</span></code>, which allows
users to <em>cache</em> items in case items are created in a computationally expensive way.</p>
<p>Note that we used a different transform for test, as we want to use items from test
to actually evaluate our model using proper metrics such as SI-SDR.</p>
<p>Next, let’s put together our model and start feeding data into it.</p>
</div>
</div>
<div class="section" id="building-the-model">
<h2>Building the model<a class="headerlink" href="#building-the-model" title="Permalink to this headline">¶</a></h2>
<p>We’ll use the model we built up in the previous chapter - a recurrent mask-inference model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nussl.ml.networks.modules</span> <span class="kn">import</span> <span class="n">AmplitudeToDB</span><span class="p">,</span> <span class="n">BatchNorm</span><span class="p">,</span> <span class="n">RecurrentStack</span><span class="p">,</span> <span class="n">Embedding</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">num_audio_channels</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span>
                 <span class="n">num_layers</span><span class="p">,</span> <span class="n">bidirectional</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">num_sources</span><span class="p">,</span> 
                <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_to_db</span> <span class="o">=</span> <span class="n">AmplitudeToDB</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_normalization</span> <span class="o">=</span> <span class="n">BatchNorm</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_stack</span> <span class="o">=</span> <span class="n">RecurrentStack</span><span class="p">(</span>
            <span class="n">num_features</span> <span class="o">*</span> <span class="n">num_audio_channels</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> 
            <span class="n">num_layers</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bidirectional</span><span class="p">),</span> <span class="n">dropout</span>
        <span class="p">)</span>
        <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bidirectional</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">num_features</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> 
                                   <span class="n">num_sources</span><span class="p">,</span> <span class="n">activation</span><span class="p">,</span> 
                                   <span class="n">num_audio_channels</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">mix_magnitude</span> <span class="o">=</span> <span class="n">data</span> <span class="c1"># save for masking</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_to_db</span><span class="p">(</span><span class="n">mix_magnitude</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_stack</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">estimates</span> <span class="o">=</span> <span class="n">mix_magnitude</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
        
        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span>
            <span class="s1">&#39;estimates&#39;</span><span class="p">:</span> <span class="n">estimates</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">nussl</span></code> has a special class - <code class="docutils literal notranslate"><span class="pre">nussl.ml.SeparationModel</span></code> which all models must integrate with. This is for
ease of deployment. The model code above is not yet built how <code class="docutils literal notranslate"><span class="pre">nussl</span></code> expects.
Integrating a model with <code class="docutils literal notranslate"><span class="pre">nussl</span></code> is an easy three-step process:</p>
<ol class="simple">
<li><p><em>Register</em> your model code with nussl via <code class="docutils literal notranslate"><span class="pre">nussl.ml.register_module</span></code>.</p></li>
<li><p><em>Build</em> a configuration function for your model that defines the inputs and outputs.</p></li>
<li><p><em>Instantiate</em> your model via the output of the configuration function.</p></li>
</ol>
<p>Let’s convert the model above into a <code class="docutils literal notranslate"><span class="pre">SeparationModel</span></code> that is compatible with <code class="docutils literal notranslate"><span class="pre">nussl</span></code> by
adding a class method. We’ll also give our model a more descriptive name than <code class="docutils literal notranslate"><span class="pre">Model</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nussl.ml.networks.modules</span> <span class="kn">import</span> <span class="n">AmplitudeToDB</span><span class="p">,</span> <span class="n">BatchNorm</span><span class="p">,</span> <span class="n">RecurrentStack</span><span class="p">,</span> <span class="n">Embedding</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">class</span> <span class="nc">MaskInference</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">num_audio_channels</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span>
                 <span class="n">num_layers</span><span class="p">,</span> <span class="n">bidirectional</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">num_sources</span><span class="p">,</span> 
                <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_to_db</span> <span class="o">=</span> <span class="n">AmplitudeToDB</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_normalization</span> <span class="o">=</span> <span class="n">BatchNorm</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_stack</span> <span class="o">=</span> <span class="n">RecurrentStack</span><span class="p">(</span>
            <span class="n">num_features</span> <span class="o">*</span> <span class="n">num_audio_channels</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> 
            <span class="n">num_layers</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bidirectional</span><span class="p">),</span> <span class="n">dropout</span>
        <span class="p">)</span>
        <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bidirectional</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">num_features</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> 
                                   <span class="n">num_sources</span><span class="p">,</span> <span class="n">activation</span><span class="p">,</span> 
                                   <span class="n">num_audio_channels</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">mix_magnitude</span> <span class="o">=</span> <span class="n">data</span> <span class="c1"># save for masking</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_to_db</span><span class="p">(</span><span class="n">mix_magnitude</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_stack</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">estimates</span> <span class="o">=</span> <span class="n">mix_magnitude</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
        
        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span>
            <span class="s1">&#39;estimates&#39;</span><span class="p">:</span> <span class="n">estimates</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="c1"># Added function</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">num_audio_channels</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> 
              <span class="n">num_layers</span><span class="p">,</span> <span class="n">bidirectional</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">num_sources</span><span class="p">,</span> 
              <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">):</span>
        <span class="c1"># Step 1. Register our model with nussl</span>
        <span class="n">nussl</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        
        <span class="c1"># Step 2a: Define the building blocks.</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;MaskInference&#39;</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;num_features&#39;</span><span class="p">:</span> <span class="n">num_features</span><span class="p">,</span>
                    <span class="s1">&#39;num_audio_channels&#39;</span><span class="p">:</span> <span class="n">num_audio_channels</span><span class="p">,</span>
                    <span class="s1">&#39;hidden_size&#39;</span><span class="p">:</span> <span class="n">hidden_size</span><span class="p">,</span>
                    <span class="s1">&#39;num_layers&#39;</span><span class="p">:</span> <span class="n">num_layers</span><span class="p">,</span>
                    <span class="s1">&#39;bidirectional&#39;</span><span class="p">:</span> <span class="n">bidirectional</span><span class="p">,</span>
                    <span class="s1">&#39;dropout&#39;</span><span class="p">:</span> <span class="n">dropout</span><span class="p">,</span>
                    <span class="s1">&#39;num_sources&#39;</span><span class="p">:</span> <span class="n">num_sources</span><span class="p">,</span>
                    <span class="s1">&#39;activation&#39;</span><span class="p">:</span> <span class="n">activation</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        
        <span class="c1"># Step 2b: Define the connections between input and output.</span>
        <span class="c1"># Here, the mix_magnitude key is the only input to the model.</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mix_magnitude&#39;</span><span class="p">]]</span>
        <span class="p">]</span>
        
        <span class="c1"># Step 2c. The model outputs a dictionary, which SeparationModel will</span>
        <span class="c1"># change the keys to model:mask, model:estimates. The lines below </span>
        <span class="c1"># alias model:mask to just mask, and model:estimates to estimates.</span>
        <span class="c1"># This will be important later when we actually deploy our model.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;estimates&#39;</span><span class="p">]:</span>
            <span class="n">modules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;Alias&#39;</span><span class="p">}</span>
            <span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;model:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        
        <span class="c1"># Step 2d. There are two outputs from our SeparationModel: estimates and mask.</span>
        <span class="c1"># Then put it all together.</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;estimates&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,]</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;modules&#39;</span><span class="p">:</span> <span class="n">modules</span><span class="p">,</span>
            <span class="s1">&#39;connections&#39;</span><span class="p">:</span> <span class="n">connections</span><span class="p">,</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">output</span>
        <span class="p">}</span>
        <span class="c1"># Step 3. Instantiate the model as a SeparationModel.</span>
        <span class="k">return</span> <span class="n">nussl</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">SeparationModel</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="n">nf</span> <span class="o">=</span> <span class="n">stft_params</span><span class="o">.</span><span class="n">window_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">nac</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MaskInference</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">nac</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SeparationModel</span></code> contain a lot more than just your model! They also include a lot
of metadata about your model, including snapshots of your code! Let’s look at the
model config:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;name&#39;: &#39;MaskInference&#39;, &#39;modules&#39;: {&#39;model&#39;: {&#39;class&#39;: &#39;MaskInference&#39;, &#39;args&#39;: {&#39;num_features&#39;: 257, &#39;num_audio_channels&#39;: 1, &#39;hidden_size&#39;: 50, &#39;num_layers&#39;: 2, &#39;bidirectional&#39;: True, &#39;dropout&#39;: 0.3, &#39;num_sources&#39;: 1, &#39;activation&#39;: &#39;sigmoid&#39;}, &#39;module_snapshot&#39;: &#39;No module snapshot could be found. Did you define your class in an interactive Python environment? See https://bugs.python.org/issue12920 for more details.&#39;}, &#39;mask&#39;: {&#39;class&#39;: &#39;Alias&#39;, &#39;module_snapshot&#39;: &#39;class Alias(nn.Module):\n    &quot;&quot;&quot;\n    Super simple module that just passes the data through without altering it, so\n    that the output of a model can be renamed in a SeparationModel.\n    &quot;&quot;&quot;\n    def forward(self, data):\n        return data\n&#39;, &#39;args&#39;: {}}, &#39;estimates&#39;: {&#39;class&#39;: &#39;Alias&#39;, &#39;module_snapshot&#39;: &#39;class Alias(nn.Module):\n    &quot;&quot;&quot;\n    Super simple module that just passes the data through without altering it, so\n    that the output of a model can be renamed in a SeparationModel.\n    &quot;&quot;&quot;\n    def forward(self, data):\n        return data\n&#39;, &#39;args&#39;: {}}}, &#39;connections&#39;: [[&#39;model&#39;, [&#39;mix_magnitude&#39;]], [&#39;mask&#39;, &#39;model:mask&#39;], [&#39;estimates&#39;, &#39;model:estimates&#39;]], &#39;output&#39;: [&#39;estimates&#39;, &#39;mask&#39;]}
</pre></div>
</div>
</div>
</div>
<p>Printing the actual model appends some information about the number of parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SeparationModel(
  (layers): ModuleDict(
    (estimates): Alias()
    (mask): Alias()
    (model): MaskInference(
      (amplitude_to_db): AmplitudeToDB()
      (input_normalization): BatchNorm(
        (batch_norm): BatchNorm1d(257, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (recurrent_stack): RecurrentStack(
        (rnn): LSTM(257, 50, num_layers=2, batch_first=True, dropout=0.3, bidirectional=True)
      )
      (embedding): Embedding(
        (linear): Linear(in_features=100, out_features=257, bias=True)
      )
    )
  )
)
Number of parameters: 210871
</pre></div>
</div>
</div>
</div>
<p>The actual configuration of the model is always known as well inside the config:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;num_features&#39;: 257,
 &#39;num_audio_channels&#39;: 1,
 &#39;hidden_size&#39;: 50,
 &#39;num_layers&#39;: 2,
 &#39;bidirectional&#39;: True,
 &#39;dropout&#39;: 0.3,
 &#39;num_sources&#39;: 1,
 &#39;activation&#39;: &#39;sigmoid&#39;}
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s look at one of these snapshots:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;module_snapshot&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No module snapshot could be found. Did you define your class in an interactive Python environment? See https://bugs.python.org/issue12920 for more details.
</pre></div>
</div>
</div>
</div>
<p>Uh oh! Since we’re working in a IPython notebook, the <code class="docutils literal notranslate"><span class="pre">inspect</span></code> module we’re using in Python
doesn’t work (see https://bugs.python.org/issue12920). Let’s import the same exact model code
from our <code class="docutils literal notranslate"><span class="pre">common</span></code> library instead, and take a look:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">common.models</span> <span class="kn">import</span> <span class="n">MaskInference</span>

<span class="n">nf</span> <span class="o">=</span> <span class="n">stft_params</span><span class="o">.</span><span class="n">window_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">nac</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MaskInference</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">nac</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;module_snapshot&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class MaskInference(nn.Module):
    def __init__(self, num_features, num_audio_channels, hidden_size,
                 num_layers, bidirectional, dropout, num_sources, 
                activation=&#39;sigmoid&#39;):
        super().__init__()
        
        self.amplitude_to_db = AmplitudeToDB()
        self.input_normalization = BatchNorm(num_features)
        self.recurrent_stack = RecurrentStack(
            num_features * num_audio_channels, hidden_size, 
            num_layers, bool(bidirectional), dropout
        )
        hidden_size = hidden_size * (int(bidirectional) + 1)
        self.embedding = Embedding(num_features, hidden_size, 
                                   num_sources, activation, 
                                   num_audio_channels)
        
    def forward(self, data):
        mix_magnitude = data # save for masking
        
        data = self.amplitude_to_db(mix_magnitude)
        data = self.input_normalization(data)
        data = self.recurrent_stack(data)
        mask = self.embedding(data)
        estimates = mix_magnitude.unsqueeze(-1) * mask
        
        output = {
            &#39;mask&#39;: mask,
            &#39;estimates&#39;: estimates
        }
        return output
    
    # Added function
    @staticmethod
    @argbind.bind_to_parser()
    def build(num_features, num_audio_channels, hidden_size, 
              num_layers, bidirectional, dropout, num_sources, 
              activation=&#39;sigmoid&#39;):
        # Step 1. Register our model with nussl
        nussl.ml.register_module(MaskInference)
        
        # Step 2a: Define the building blocks.
        modules = {
            &#39;model&#39;: {
                &#39;class&#39;: &#39;MaskInference&#39;,
                &#39;args&#39;: {
                    &#39;num_features&#39;: num_features,
                    &#39;num_audio_channels&#39;: num_audio_channels,
                    &#39;hidden_size&#39;: hidden_size,
                    &#39;num_layers&#39;: num_layers,
                    &#39;bidirectional&#39;: bidirectional,
                    &#39;dropout&#39;: dropout,
                    &#39;num_sources&#39;: num_sources,
                    &#39;activation&#39;: activation
                }
            }
        }
        
        # Step 2b: Define the connections between input and output.
        # Here, the mix_magnitude key is the only input to the model.
        connections = [
            [&#39;model&#39;, [&#39;mix_magnitude&#39;]]
        ]
        
        # Step 2c. The model outputs a dictionary, which SeparationModel will
        # change the keys to model:mask, model:estimates. The lines below 
        # alias model:mask to just mask, and model:estimates to estimates.
        # This will be important later when we actually deploy our model.
        for key in [&#39;mask&#39;, &#39;estimates&#39;]:
            modules[key] = {&#39;class&#39;: &#39;Alias&#39;}
            connections.append([key, [f&#39;model:{key}&#39;]])
        
        # Step 2d. There are two outputs from our SeparationModel: estimates and mask.
        # Then put it all together.
        output = [&#39;estimates&#39;, &#39;mask&#39;,]
        config = {
            &#39;name&#39;: &#39;MaskInference&#39;,
            &#39;modules&#39;: modules,
            &#39;connections&#39;: connections,
            &#39;output&#39;: output
        }
        # Step 3. Instantiate the model as a SeparationModel.
        return nussl.ml.SeparationModel(config)
</pre></div>
</div>
</div>
</div>
<p>Now, if we make changes to the model as we are iterating in experiments, the model code
is always saved with every checkpoint.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you don’t trust your checkpoints, NEVER run code directly from a string via eval unless
you know exactly what it is going to do. Module snapshots are meant just to keep track
of changes as you iterate in experiments. If you trust them, you can create the class from
the string, but it’s strongly discouraged for security reasons.</p>
</div>
<p>Now that we’ve got a model, let’s feed an item from our dataset into it. We’ll need to do
two things for this to work:</p>
<ol class="simple">
<li><p>Add a batch dimension by unsqueezing along the 0th axis.</p></li>
<li><p>Cast the item to a <code class="docutils literal notranslate"><span class="pre">float</span></code>, the way PyTorch expects it.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
        <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">25</span><span class="o">-</span><span class="n">d1087b1ea364</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;train_data&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>What’s in the output? Let’s take a look:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">26</span><span class="o">-</span><span class="mi">51</span><span class="n">ccc59bc2b8</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;output&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We’ve got the estimates and we’ve got a mask! You can also put <code class="docutils literal notranslate"><span class="pre">SeparationModel</span></code>s
into <code class="docutils literal notranslate"> <span class="pre">verbose</span></code> mode to see exactly what’s happening in the forward pass:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">27</span><span class="o">-</span><span class="mi">6</span><span class="n">fba1412f264</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;item&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>This is really useful to see whether or not activations are getting saturated,
what the range of the data is at each layer, etc. Putting models into verbose
mode is a handy way of checking shapes and value ranges, making it useful
for debugging.</p>
<p>Alright, let’s train this model! Let’s overfit it to this single item to make
sure everything is working.</p>
</div>
<div class="section" id="training">
<h2>Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h2>
<p>The core of training a model is to set up the training loop. To do this, we need
to set up a few things:</p>
<ul class="simple">
<li><p>Loss function: this is what we’re optimizing for. We want to change our model
parameters such that the loss function goes <em>down</em>.</p></li>
<li><p>Optimizer: this is what actually takes a step on the model parameters.</p></li>
</ul>
<p>If you’ve done deep learning with PyTorch before, the steps below will make
sense. The way we’re going to formulate this is to define a function that, given
a single batch of data, how to take a <em>training</em> step on for the model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="n">nf</span> <span class="o">=</span> <span class="n">stft_params</span><span class="o">.</span><span class="n">window_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">nac</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MaskInference</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">nac</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="c1"># forward pass</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;estimates&#39;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># backwards + gradient step</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="c1"># return the loss for bookkeeping.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SeparationModel(
  (layers): ModuleDict(
    (estimates): Alias()
    (mask): Alias()
    (model): MaskInference(
      (amplitude_to_db): AmplitudeToDB()
      (input_normalization): BatchNorm(
        (batch_norm): BatchNorm1d(257, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
      (recurrent_stack): RecurrentStack(
        (rnn): LSTM(257, 50, batch_first=True, bidirectional=True)
      )
      (embedding): Embedding(
        (linear): Linear(in_features=100, out_features=257, bias=True)
      )
    )
  )
)
Number of parameters: 150071
</pre></div>
</div>
</div>
</div>
<p>Now let’s make a batch and pass it through the model, and call
<code class="docutils literal notranslate"><span class="pre">train_step</span></code> over and over to train the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="c1"># Comment out the line above to see the output</span>
<span class="c1"># of this cell in Colab or Jupyter Notebook</span>
<span class="kn">import</span> <span class="nn">tqdm</span>

<span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Because of the transforms, this produces tensors.</span>
<span class="n">batch</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># A batch of size 1, in this case. Usually we&#39;d have more.</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
        <span class="n">batch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
<span class="n">N_ITERATIONS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">loss_history</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># For bookkeeping</span>

<span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_ITERATIONS</span><span class="p">))</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
    <span class="n">loss_val</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">loss_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_val</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loss: </span><span class="si">{</span><span class="n">loss_val</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">29</span><span class="o">-</span><span class="mi">9</span><span class="n">db2d715ea65</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">tqdm</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">item</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Because of the transforms, this produces tensors.</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">batch</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># A batch of size 1, in this case. Usually we&#39;d have more.</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>

<span class="ne">NameError</span>: name &#39;train_data&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_history</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of iterations&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Training loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train loss history of our model&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">30</span><span class="o">-</span><span class="mi">6</span><span class="n">d8ddee8661d</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_history</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of iterations&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Training loss&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train loss history of our model&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;loss_history&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p><em>nussl</em> comes loaded with a bunch of training utilities, which are powered by
<a class="reference external" href="https://github.com/pytorch/ignite">PyTorch Ignite</a>. These utilities abstract away
some of the steps above. The key concept of PyTorch Ignite is the “engine”. An engine
essentially calls our training function on batches from the dataset, for a set number
of epochs. Engines also fire off a bunch of events during training that can be captured
and handled by callback functions. For more detailed information, check out the
<a class="reference external" href="https://pytorch.org/ignite/engine.html#ignite-engine">PyTorch Ignite documentation</a>. To
make things compatible with Ignite, we have to change the <code class="docutils literal notranslate"><span class="pre">train_step</span></code> function a bit to
take an <em>engine</em> as the first argument. We’ll also change it so that it returns a dictionary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="c1"># forward pass</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;estimates&#39;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># backwards + gradient step</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    
    <span class="n">loss_vals</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;L1Loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">loss_vals</span> <span class="c1"># return the loss for bookkeeping.</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll also need a validation step, which doesn’t actually update the model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">val_step</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="c1"># forward pass</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;estimates&#39;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span>
    <span class="p">)</span>    
    <span class="n">loss_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L1Loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">loss_vals</span> <span class="c1"># return the loss for bookkeeping.</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s build up our entire training script, using <em>nussl</em>. We’ll copy paste
things from above so that it’s all in one spot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nussl</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">nussl.datasets</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">nussl_tfm</span>
<span class="kn">from</span> <span class="nn">common.models</span> <span class="kn">import</span> <span class="n">MaskInference</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">utils</span><span class="o">.</span><span class="n">logger</span><span class="p">()</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>
<span class="n">MAX_MIXTURES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e8</span><span class="p">)</span> <span class="c1"># We&#39;ll set this to some impossibly high number for on the fly mixing.</span>

<span class="n">stft_params</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">STFTParams</span><span class="p">(</span><span class="n">window_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="n">tfm</span> <span class="o">=</span> <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">SumSources</span><span class="p">([[</span><span class="s1">&#39;bass&#39;</span><span class="p">,</span> <span class="s1">&#39;drums&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]]),</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">MagnitudeSpectrumApproximation</span><span class="p">(),</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">IndexSources</span><span class="p">(</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">nussl_tfm</span><span class="o">.</span><span class="n">ToSeparationModel</span><span class="p">(),</span>
<span class="p">])</span>

<span class="n">train_folder</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/train&quot;</span>
<span class="n">val_folder</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/valid&quot;</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> 
    <span class="n">fg_path</span><span class="o">=</span><span class="n">train_folder</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="n">MAX_MIXTURES</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> 
    <span class="n">fg_path</span><span class="o">=</span><span class="n">val_folder</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">val_data</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">nf</span> <span class="o">=</span> <span class="n">stft_params</span><span class="o">.</span><span class="n">window_length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MaskInference</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="c1"># forward pass</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;estimates&#39;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># backwards + gradient step</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    
    <span class="n">loss_vals</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;L1Loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">loss_vals</span>

<span class="k">def</span> <span class="nf">val_step</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="c1"># forward pass</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;estimates&#39;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;source_magnitudes&#39;</span><span class="p">]</span>
    <span class="p">)</span>    
    <span class="n">loss_vals</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;L1Loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> 
        <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">loss_vals</span>

<span class="c1"># Create the engines</span>
<span class="n">trainer</span><span class="p">,</span> <span class="n">validator</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">create_train_and_validation_engines</span><span class="p">(</span>
    <span class="n">train_step</span><span class="p">,</span> <span class="n">val_step</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span>
<span class="p">)</span>

<span class="c1"># We&#39;ll save the output relative to this notebook.</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

<span class="c1"># Adding handlers from nussl that print out details about model training</span>
<span class="c1"># run the validation step, and save the models.</span>
<span class="n">nussl</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">add_stdout_handler</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>
<span class="n">nussl</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">add_validate_and_checkpoint</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> 
    <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">val_dataloader</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">train_dataloader</span><span class="p">,</span> 
    <span class="n">epoch_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
    <span class="n">max_epochs</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ScaperError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">33</span><span class="o">-</span><span class="mi">0</span><span class="n">d0a68b5c5e4</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span> 
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> 
<span class="ne">---&gt; </span><span class="mi">25</span>     <span class="n">fg_path</span><span class="o">=</span><span class="n">train_folder</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="n">MAX_MIXTURES</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>     <span class="n">train_data</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/argbind.py</span> in <span class="ni">cmd_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">parse_dict_to_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span> 
<span class="ne">--&gt; </span><span class="mi">192</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>         <span class="k">return</span> <span class="n">cmd_func</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> 

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">mixer</span><span class="nt">(stft_params, transform, num_mixtures, fg_path, duration, sample_rate, ref_db, n_channels, master_label, source_file, snr, target_instrument, target_snr_boost, pitch_shift, time_stretch, coherent_prob, augment_prob, quick_pitch_time_prob, overfit, overfit_seed)</span>
<span class="g g-Whitespace">    </span><span class="mi">286</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">OnTheFly</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>         <span class="n">mix_closure</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="p">,</span> <span class="n">stft_params</span><span class="o">=</span><span class="n">stft_params</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">288</span>         <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="k">return</span> <span class="n">dataset</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">__init__</span><span class="nt">(self, mix_closure, num_mixtures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span>         <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span> <span class="o">=</span> <span class="n">mix_closure</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span> 
<span class="ne">--&gt; </span><span class="mi">404</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span>         <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;num_mixtures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_mixtures</span>
<span class="g g-Whitespace">    </span><span class="mi">406</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/base_dataset.py</span> in <span class="ni">__init__</span><span class="nt">(self, folder, transform, sample_rate, stft_params, num_channels, strict_sample_rate, cache_populated)</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span>         <span class="c1"># signals if necessary, if there are any items</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">96</span>             <span class="bp">self</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span> 
<span class="g g-Whitespace">     </span><span class="mi">98</span>     <span class="k">def</span> <span class="nf">filter_items_by_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">process_item</span><span class="nt">(self, item)</span>
<span class="g g-Whitespace">    </span><span class="mi">409</span> 
<span class="g g-Whitespace">    </span><span class="mi">410</span>     <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">411</span>         <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">412</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>             <span class="k">raise</span> <span class="n">DataSetException</span><span class="p">(</span><span class="s2">&quot;output of mix_closure must be a dict!&quot;</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">__call__</span><span class="nt">(self, dataset, i)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>         <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span>             <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">415</span>             <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_scaper_object</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>             <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent_prob</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>                 <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">_create_scaper_object</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span>         <span class="n">sc</span> <span class="o">=</span> <span class="n">scaper</span><span class="o">.</span><span class="n">Scaper</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>             <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">354</span>             <span class="n">random_state</span><span class="o">=</span><span class="n">state</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>         <span class="n">sc</span><span class="o">.</span><span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/core.py</span> in <span class="ni">__init__</span><span class="nt">(self, duration, fg_path, bg_path, protected_labels, random_state)</span>
<span class="g g-Whitespace">   </span><span class="mi">1026</span>         <span class="n">expanded_fg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span>         <span class="n">expanded_bg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">bg_path</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1028</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_bg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span>         <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span> <span class="o">=</span> <span class="n">expanded_fg_path</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/util.py</span> in <span class="ni">_validate_folder_path</span><span class="nt">(folder_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>         <span class="k">raise</span> <span class="n">ScaperError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>             <span class="s1">&#39;Folder path &quot;</span><span class="si">{:s}</span><span class="s1">&quot; does not point to a valid folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">116</span>                 <span class="nb">str</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span> 
<span class="g g-Whitespace">    </span><span class="mi">118</span> 

<span class="ne">ScaperError</span>: Folder path &quot;/home/runner/.nussl/tutorial/train&quot; does not point to a valid folder
</pre></div>
</div>
</div>
</div>
<p>Scripts like this are the starting point for your separation experiments. The script above builds up a
Scaper object which creates mixtures on the fly for training and validating the model. It then feeds
mixtures to a deep learning model. Finally, the script saves the checkpoints for the model and for
the optimizer for loading it back up.</p>
</div>
<div class="section" id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>Finally, we’ll look at how the model can be loaded into a <em>nussl</em> separation object so you can
play around with it! The way to do this is to use <em>nussl</em>’s DeepMaskEstimation class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">separator</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">separation</span><span class="o">.</span><span class="n">deep</span><span class="o">.</span><span class="n">DeepMaskEstimation</span><span class="p">(</span>
    <span class="n">nussl</span><span class="o">.</span><span class="n">AudioSignal</span><span class="p">(),</span> <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;checkpoints/best.model.pth&#39;</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/separation/base/separation_base.py:73: UserWarning: input_audio_signal has no data!
  warnings.warn(&#39;input_audio_signal has no data!&#39;)
/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/core/audio_signal.py:455: UserWarning: Initializing STFT with data that is non-complex. This might lead to weird results!
  warnings.warn(&#39;Initializing STFT with data that is non-complex. &#39;
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">34</span><span class="o">-</span><span class="mi">2780</span><span class="n">a4487a38</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">separation</span><span class="o">.</span><span class="n">deep</span><span class="o">.</span><span class="n">DeepMaskEstimation</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">nussl</span><span class="o">.</span><span class="n">AudioSignal</span><span class="p">(),</span> <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;checkpoints/best.model.pth&#39;</span><span class="p">,</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/separation/deep/deep_mask_estimation.py</span> in <span class="ni">__init__</span><span class="nt">(self, input_audio_signal, model_path, device, extra_data, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_audio_signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span>         <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">30</span>             <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>         <span class="bp">self</span><span class="o">.</span><span class="n">model_output</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>         <span class="bp">self</span><span class="o">.</span><span class="n">extra_data</span> <span class="o">=</span> <span class="n">extra_data</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/separation/base/deep_mixin.py</span> in <span class="ni">load_model</span><span class="nt">(self, model_path, device)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span><span class="s2">         safe_loader = SafeModelLoader()</span>
<span class="ne">---&gt; </span><span class="mi">35</span><span class="s2">         model_dict = safe_loader.load(model_path, &#39;cpu&#39;)</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span><span class="s2">         metadata = model_dict[&#39;metadata&#39;]</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span><span class="s2"> </span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/core/migration.py</span> in <span class="ni">load</span><span class="nt">(self, model_path, device, expected_eval)</span>
<span class="g g-Whitespace">     </span><span class="mi">79</span><span class="s2"> </span>
<span class="g g-Whitespace">     </span><span class="mi">80</span><span class="s2">     def load(self, model_path, device=&#39;cpu&#39;, expected_eval=&#39;BssEvalScale&#39;):</span>
<span class="ne">---&gt; </span><span class="mi">81</span><span class="s2">         model_dict = torch.load(model_path, map_location=device)</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span><span class="s2">         metadata = model_dict[&#39;metadata&#39;]</span>
<span class="g g-Whitespace">     </span><span class="mi">83</span><span class="s2">         metadata = self._get_moved(metadata, model_dict, model_path)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/torch/serialization.py</span> in <span class="ni">load</span><span class="nt">(f, map_location, pickle_module, **pickle_load_args)</span>
<span class="g g-Whitespace">    </span><span class="mi">569</span><span class="s2">         pickle_load_args[&#39;encoding&#39;] = &#39;utf-8&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">570</span><span class="s2"> </span>
<span class="ne">--&gt; </span><span class="mi">571</span><span class="s2">     with _open_file_like(f, &#39;rb&#39;) as opened_file:</span>
<span class="g g-Whitespace">    </span><span class="mi">572</span><span class="s2">         if _is_zipfile(opened_file):</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span><span class="s2">             # The zipfile reader is going to advance the current file position.</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/torch/serialization.py</span> in <span class="ni">_open_file_like</span><span class="nt">(name_or_buffer, mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">227</span><span class="s2"> def _open_file_like(name_or_buffer, mode):</span>
<span class="g g-Whitespace">    </span><span class="mi">228</span><span class="s2">     if _is_path(name_or_buffer):</span>
<span class="ne">--&gt; </span><span class="mi">229</span><span class="s2">         return _open_file(name_or_buffer, mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span><span class="s2">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span><span class="s2">         if &#39;w&#39; in mode:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/torch/serialization.py</span> in <span class="ni">__init__</span><span class="nt">(self, name, mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span><span class="s2"> class _open_file(_opener):</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="s2">     def __init__(self, name, mode):</span>
<span class="ne">--&gt; </span><span class="mi">210</span><span class="s2">         super(_open_file, self).__init__(open(name, mode))</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">212</span><span class="s2">     def __exit__(self, *args):</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;checkpoints/best.model.pth&#39;
</pre></div>
</div>
</div>
</div>
<p>Let’s test it on a music mixture to see what it learned!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="n">viz</span>

<span class="n">test_folder</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/test/&quot;</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="n">fg_path</span><span class="o">=</span><span class="n">test_folder</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="n">MAX_MIXTURES</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">separator</span><span class="o">.</span><span class="n">audio_signal</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mix&#39;</span><span class="p">]</span>
<span class="n">estimates</span> <span class="o">=</span> <span class="n">separator</span><span class="p">()</span>
<span class="c1"># Since our model only returns one source, let&#39;s tack on the</span>
<span class="c1"># residual (which should be accompaniment)</span>
<span class="n">estimates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;mix&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">estimates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">viz</span><span class="o">.</span><span class="n">show_sources</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ScaperError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">35</span><span class="o">-</span><span class="n">e152f8214c92</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">test_folder</span> <span class="o">=</span> <span class="s2">&quot;~/.nussl/tutorial/test/&quot;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">stft_params</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<span class="ne">----&gt; </span><span class="mi">5</span>     <span class="n">fg_path</span><span class="o">=</span><span class="n">test_folder</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="o">=</span><span class="n">MAX_MIXTURES</span><span class="p">,</span> <span class="n">coherent_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">item</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> 

<span class="nn">~/work/tutorial/tutorial/common/argbind.py</span> in <span class="ni">cmd_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_prefix</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">parse_dict_to_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span> 
<span class="ne">--&gt; </span><span class="mi">192</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>         <span class="k">return</span> <span class="n">cmd_func</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> 

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">mixer</span><span class="nt">(stft_params, transform, num_mixtures, fg_path, duration, sample_rate, ref_db, n_channels, master_label, source_file, snr, target_instrument, target_snr_boost, pitch_shift, time_stretch, coherent_prob, augment_prob, quick_pitch_time_prob, overfit, overfit_seed)</span>
<span class="g g-Whitespace">    </span><span class="mi">286</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">nussl</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">OnTheFly</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>         <span class="n">mix_closure</span><span class="p">,</span> <span class="n">num_mixtures</span><span class="p">,</span> <span class="n">stft_params</span><span class="o">=</span><span class="n">stft_params</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">288</span>         <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="k">return</span> <span class="n">dataset</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">__init__</span><span class="nt">(self, mix_closure, num_mixtures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span>         <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span> <span class="o">=</span> <span class="n">mix_closure</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span> 
<span class="ne">--&gt; </span><span class="mi">404</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span>         <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;num_mixtures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_mixtures</span>
<span class="g g-Whitespace">    </span><span class="mi">406</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/base_dataset.py</span> in <span class="ni">__init__</span><span class="nt">(self, folder, transform, sample_rate, stft_params, num_channels, strict_sample_rate, cache_populated)</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span>         <span class="c1"># signals if necessary, if there are any items</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">96</span>             <span class="bp">self</span><span class="o">.</span><span class="n">process_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span> 
<span class="g g-Whitespace">     </span><span class="mi">98</span>     <span class="k">def</span> <span class="nf">filter_items_by_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/nussl/datasets/hooks.py</span> in <span class="ni">process_item</span><span class="nt">(self, item)</span>
<span class="g g-Whitespace">    </span><span class="mi">409</span> 
<span class="g g-Whitespace">    </span><span class="mi">410</span>     <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">411</span>         <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_closure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">412</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>             <span class="k">raise</span> <span class="n">DataSetException</span><span class="p">(</span><span class="s2">&quot;output of mix_closure must be a dict!&quot;</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">__call__</span><span class="nt">(self, dataset, i)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>         <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span>             <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">415</span>             <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_scaper_object</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>             <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent_prob</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>                 <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherent</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="nn">~/work/tutorial/tutorial/common/data.py</span> in <span class="ni">_create_scaper_object</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span>         <span class="n">sc</span> <span class="o">=</span> <span class="n">scaper</span><span class="o">.</span><span class="n">Scaper</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>             <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">354</span>             <span class="n">random_state</span><span class="o">=</span><span class="n">state</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>         <span class="n">sc</span><span class="o">.</span><span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/core.py</span> in <span class="ni">__init__</span><span class="nt">(self, duration, fg_path, bg_path, protected_labels, random_state)</span>
<span class="g g-Whitespace">   </span><span class="mi">1026</span>         <span class="n">expanded_fg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span>         <span class="n">expanded_bg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">bg_path</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1028</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_fg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span>         <span class="n">_validate_folder_path</span><span class="p">(</span><span class="n">expanded_bg_path</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span>         <span class="bp">self</span><span class="o">.</span><span class="n">fg_path</span> <span class="o">=</span> <span class="n">expanded_fg_path</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.9/x64/lib/python3.7/site-packages/scaper/util.py</span> in <span class="ni">_validate_folder_path</span><span class="nt">(folder_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>         <span class="k">raise</span> <span class="n">ScaperError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>             <span class="s1">&#39;Folder path &quot;</span><span class="si">{:s}</span><span class="s1">&quot; does not point to a valid folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">116</span>                 <span class="nb">str</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span> 
<span class="g g-Whitespace">    </span><span class="mi">118</span> 

<span class="ne">ScaperError</span>: Folder path &quot;/home/runner/.nussl/tutorial/test/&quot; does not point to a valid folder
</pre></div>
</div>
</div>
</div>
<p>Clearly, the model needs more training. But it’s a start! So far it has learned
the frequency bands where things can be separated.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Go back to the training script above and change the hyperparameters! Most importantly,
change the number of epochs that it runs for, as well as the epoch length. You’ll start
to see more reasonable results after around 25 epochs, usually.</p>
</div>
<p>Finally, as we’ve done for other algorithms already, let’s interact with our model!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">separator</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">share</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;microphone&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">36</span><span class="o">-</span><span class="mi">867</span><span class="n">d1ced5147</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">separator</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">share</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;microphone&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;separator&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Share the link with your colleagues or collaborators so they can investigate your model
as well!</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "source-separation/tutorial",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./training"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="building_blocks.html" title="previous page">Code for Building Blocks</a>
    <a class='right-next' id="next-link" href="../conclusions/applications.html" title="next page">Applications</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Ethan Manilow, Prem Seetharaman, Justin Salamon<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-180111316-1', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    
  </body>
</html>